<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE jasperReport PUBLIC "-//JasperReports//DTD Report Design//EN" "http://jasperreports.sourceforge.net/dtds/jasperreport.dtd">
<jasperReport name="trips_status" pageWidth="842" pageHeight="595" orientation="Landscape" columnWidth="782" leftMargin="30" rightMargin="30" topMargin="20" bottomMargin="20" isSummaryNewPage="true">
    <property name="net.sf.jasperreports.default.font.name" value="DejaVu Sans"/>
    <property name="net.sf.jasperreports.default.pdf.font.name" value="DejaVu Sans"/>
    <property name="net.sf.jasperreports.default.pdf.encoding" value="Identity-H"/>
    <property name="net.sf.jasperreports.default.pdf.embedded" value="true"/>
    <style name="BaseStyle" isDefault="true" fontName="DejaVu Sans" pdfFontName="DejaVu Sans" pdfEncoding="Identity-H" isPdfEmbedded="true"/>

    <parameter name="REPORT_TITLE" class="java.lang.String"/>
    <parameter name="printedDate" class="java.lang.String"/>
    <parameter name="printedBy" class="java.lang.String"/>
    <parameter name="fromDate" class="java.lang.String"/>
    <parameter name="toDate" class="java.lang.String"/>
    <parameter name="reportCode" class="java.lang.String"/>
    <parameter name="LOGO_STREAM" class="java.io.InputStream"/>

    <field name="status" class="java.lang.String"/>
    <field name="total" class="java.lang.Long"/>

    <variable name="vTotalTrips" class="java.lang.Long" resetType="Report" calculation="Sum">
        <variableExpression><![CDATA[$F{total} == null ? 0L : $F{total}]]></variableExpression>
    </variable>
    <variable name="vCompletedTrips" class="java.lang.Long" resetType="Report" calculation="Sum">
        <variableExpression><![CDATA["Đã chạy".equals($F{status}) ? ($F{total} == null ? 0L : $F{total}) : 0L]]></variableExpression>
    </variable>
    <variable name="vCanceledTrips" class="java.lang.Long" resetType="Report" calculation="Sum">
        <variableExpression><![CDATA["Bị hủy".equals($F{status}) ? ($F{total} == null ? 0L : $F{total}) : 0L]]></variableExpression>
    </variable>

    <title>
        <band height="80">
            <image scaleImage="RetainShape">
                <reportElement x="0" y="0" width="60" height="30"/>
                <imageExpression><![CDATA[$P{LOGO_STREAM}]]></imageExpression>
            </image>
            <textField>
                <reportElement x="70" y="0" width="712" height="30"/>
                <textElement textAlignment="Center" verticalAlignment="Middle">
                    <font size="16" isBold="true"/>
                </textElement>
                <textFieldExpression><![CDATA[$P{REPORT_TITLE}]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="0" y="35" width="260" height="15"/>
                <textElement>
                    <font size="9"/>
                </textElement>
                <textFieldExpression><![CDATA["Ngày xuất báo cáo: " + ($P{printedDate} == null ? "" : $P{printedDate})]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="260" y="35" width="260" height="15"/>
                <textElement>
                    <font size="9"/>
                </textElement>
                <textFieldExpression><![CDATA["Người thực hiện: " + ($P{printedBy} == null ? "" : $P{printedBy})]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="520" y="35" width="262" height="15"/>
                <textElement textAlignment="Right">
                    <font size="9"/>
                </textElement>
                <textFieldExpression><![CDATA["Mã báo cáo: " + ($P{reportCode} == null ? "" : $P{reportCode})]]></textFieldExpression>
            </textField>

            <textField>
                <reportElement x="0" y="55" width="400" height="15"/>
                <textElement>
                    <font size="9"/>
                </textElement>
                <textFieldExpression><![CDATA["Khoảng thời gian: " + ($P{fromDate} == null ? "" : $P{fromDate}) + " - " + ($P{toDate} == null ? "" : $P{toDate})]]></textFieldExpression>
            </textField>
        </band>
    </title>

    <columnHeader>
        <band height="24">
            <rectangle>
                <reportElement x="0" y="0" width="782" height="24" backcolor="#F5F7FA" mode="Opaque"/>
            </rectangle>
            <staticText>
                <reportElement x="0" y="0" width="582" height="24"/>
                <textElement textAlignment="Left" verticalAlignment="Middle"><font isBold="true"/></textElement>
                <text><![CDATA[Tình trạng]]></text>
            </staticText>
            <staticText>
                <reportElement x="582" y="0" width="200" height="24"/>
                <textElement textAlignment="Right" verticalAlignment="Middle"><font isBold="true"/></textElement>
                <text><![CDATA[Số chuyến]]></text>
            </staticText>
        </band>
    </columnHeader>

    <detail>
        <band height="20">
            <rectangle>
                <reportElement x="0" y="0" width="782" height="20"/>
            </rectangle>
            <textField>
                <reportElement x="0" y="0" width="582" height="20"/>
                <textElement verticalAlignment="Middle"/>
                <textFieldExpression><![CDATA[$F{status}]]></textFieldExpression>
            </textField>
            <textField pattern="#,##0">
                <reportElement x="582" y="0" width="200" height="20"/>
                <textElement textAlignment="Right" verticalAlignment="Middle"/>
                <textFieldExpression><![CDATA[$F{total} == null ? 0L : $F{total}]]></textFieldExpression>
            </textField>
        </band>
    </detail>

    <columnFooter>
        <band height="20">
            <rectangle>
                <reportElement x="0" y="0" width="782" height="20" backcolor="#E9F2FF" mode="Opaque"/>
            </rectangle>
            <staticText>
                <reportElement x="0" y="0" width="582" height="20"/>
                <textElement verticalAlignment="Middle">
                    <font size="9" isBold="true"/>
                </textElement>
                <text><![CDATA[Tổng số chuyến]]></text>
            </staticText>
            <textField pattern="#,##0">
                <reportElement x="582" y="0" width="200" height="20"/>
                <textElement textAlignment="Right" verticalAlignment="Middle"/>
                <textFieldExpression><![CDATA[$V{vTotalTrips} == null ? 0L : $V{vTotalTrips}]]></textFieldExpression>
            </textField>
        </band>
    </columnFooter>

    <pageFooter>
        <band height="40">
            <textField>
                <reportElement x="0" y="0" width="120" height="14"/>
                <textElement verticalAlignment="Middle">
                    <font size="9"/>
                </textElement>
                <textFieldExpression><![CDATA["Trang " + $V{PAGE_NUMBER} + " /"]]></textFieldExpression>
            </textField>
            <textField evaluationTime="Report">
                <reportElement x="120" y="0" width="30" height="14"/>
                <textElement verticalAlignment="Middle">
                    <font size="9"/>
                </textElement>
                <textFieldExpression><![CDATA[$V{PAGE_NUMBER}]]></textFieldExpression>
            </textField>
            <textField>
                <reportElement x="350" y="0" width="432" height="14"/>
                <textElement textAlignment="Right" verticalAlignment="Middle">
                    <font size="9"/>
                </textElement>
                <textFieldExpression><![CDATA["Xuất ngày: " + ($P{printedDate} == null ? "" : $P{printedDate})]]></textFieldExpression>
            </textField>
            <staticText>
                <reportElement x="0" y="16" width="400" height="12"/>
                <textElement verticalAlignment="Middle">
                    <font size="9"/>
                </textElement>
                <text><![CDATA[Báo cáo tình trạng chuyến xe BC-TC-004 – Version 1.0]]></text>
            </staticText>
            <staticText>
                <reportElement x="0" y="28" width="400" height="12"/>
                <textElement verticalAlignment="Middle">
                    <font size="9"/>
                </textElement>
                <text><![CDATA[© 2025 – Hệ thống đặt vé xe]]></text>
            </staticText>
        </band>
    </pageFooter>

    <summary>
        <band height="555">
            <frame>
                <reportElement x="0" y="0" width="782" height="70"/>

                <frame>
                    <reportElement x="0" y="0" width="260" height="35"/>
                    <staticText>
                        <reportElement x="0" y="0" width="260" height="15"/>
                        <textElement><font isBold="true" size="10"/></textElement>
                        <text><![CDATA[Tổng số chuyến]]></text>
                    </staticText>
                    <textField pattern="#,##0">
                        <reportElement x="0" y="18" width="260" height="17"/>
                        <textElement textAlignment="Right"><font size="10"/></textElement>
                        <textFieldExpression><![CDATA[$V{vTotalTrips} == null ? 0L : $V{vTotalTrips}]]></textFieldExpression>
                    </textField>
                </frame>

                <frame>
                    <reportElement x="275" y="0" width="260" height="35"/>
                    <staticText>
                        <reportElement x="0" y="0" width="260" height="15"/>
                        <textElement><font isBold="true" size="10"/></textElement>
                        <text><![CDATA[Chuyến chạy thành công]]></text>
                    </staticText>
                    <textField pattern="#,##0">
                        <reportElement x="0" y="18" width="260" height="17"/>
                        <textElement textAlignment="Right"><font size="10"/></textElement>
                        <textFieldExpression><![CDATA[$V{vCompletedTrips} == null ? 0L : $V{vCompletedTrips}]]></textFieldExpression>
                    </textField>
                </frame>

                <frame>
                    <reportElement x="0" y="35" width="260" height="35"/>
                    <staticText>
                        <reportElement x="0" y="0" width="260" height="15"/>
                        <textElement><font isBold="true" size="10"/></textElement>
                        <text><![CDATA[Chuyến bị hủy]]></text>
                    </staticText>
                    <textField pattern="#,##0">
                        <reportElement x="0" y="18" width="260" height="17"/>
                        <textElement textAlignment="Right"><font size="10"/></textElement>
                        <textFieldExpression><![CDATA[$V{vCanceledTrips} == null ? 0L : $V{vCanceledTrips}]]></textFieldExpression>
                    </textField>
                </frame>

                <frame>
                    <reportElement x="275" y="35" width="260" height="35"/>
                    <staticText>
                        <reportElement x="0" y="0" width="260" height="15"/>
                        <textElement><font isBold="true" size="10"/></textElement>
                        <text><![CDATA[Tỉ lệ hủy (%)]]></text>
                    </staticText>
                    <textField pattern="#0.00'%'">
                        <reportElement x="0" y="18" width="260" height="17"/>
                        <textElement textAlignment="Right"><font size="10"/></textElement>
                        <textFieldExpression><![CDATA[
                            ($V{vTotalTrips} == null || $V{vTotalTrips}.longValue() == 0L)
                                ? 0.0
                                : ($V{vCanceledTrips}.doubleValue() * 100.0 / $V{vTotalTrips}.doubleValue())
                        ]]></textFieldExpression>
                    </textField>
                </frame>
            </frame>

            <pieChart>
                <chart>
                    <reportElement x="0" y="80" width="782" height="260"/>
                    <chartTitle>
                        <font size="11" isBold="true"/>
                        <titleExpression><![CDATA["Tỉ lệ chuyến chạy / hủy"]]></titleExpression>
                    </chartTitle>
                </chart>
                <pieDataset>
                    <dataset/>
                    <keyExpression><![CDATA[$F{status}]]></keyExpression>
                    <valueExpression><![CDATA[$F{total} == null ? 0L : $F{total}]]></valueExpression>
                </pieDataset>
                <piePlot>
                    <plot/>
                </piePlot>
            </pieChart>

            <!-- Manual footer for summary page (since pageFooter is not rendered on summary new page in this Jasper version) -->
            <frame>
                <reportElement x="0" y="515" width="782" height="40"/>
                <textField>
                    <reportElement x="0" y="0" width="120" height="14"/>
                    <textElement verticalAlignment="Middle">
                        <font size="9"/>
                    </textElement>
                    <textFieldExpression><![CDATA["Trang " + $V{PAGE_NUMBER} + " /"]]></textFieldExpression>
                </textField>
                <textField evaluationTime="Report">
                    <reportElement x="120" y="0" width="30" height="14"/>
                    <textElement verticalAlignment="Middle">
                        <font size="9"/>
                    </textElement>
                    <textFieldExpression><![CDATA[$V{PAGE_NUMBER}]]></textFieldExpression>
                </textField>
                <textField>
                    <reportElement x="350" y="0" width="432" height="14"/>
                    <textElement textAlignment="Right" verticalAlignment="Middle">
                        <font size="9"/>
                    </textElement>
                    <textFieldExpression><![CDATA["Xuất ngày: " + ($P{printedDate} == null ? "" : $P{printedDate})]]></textFieldExpression>
                </textField>
                <staticText>
                    <reportElement x="0" y="16" width="400" height="12"/>
                    <textElement verticalAlignment="Middle">
                        <font size="9"/>
                    </textElement>
                    <text><![CDATA[Báo cáo tình trạng chuyến xe BC-TC-004 – Version 1.0]]></text>
                </staticText>
                <staticText>
                    <reportElement x="0" y="28" width="400" height="12"/>
                    <textElement verticalAlignment="Middle">
                        <font size="9"/>
                    </textElement>
                    <text><![CDATA[© 2025 – Hệ thống đặt vé xe]]></text>
                </staticText>
            </frame>
        </band>
    </summary>

</jasperReport>
